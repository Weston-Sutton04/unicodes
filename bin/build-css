#!/usr/bin/env bash

cd "$(dirname "$BASH_SOURCE")"/..

source etc/env.sh

# tmp dir
mkdir -p tmp share

# resets first
find . -name "*reset.less"\
       -not -path "./node_modules/*"\
       -not -path "./tmp/*" | sed 's|\(.*\)|@import ".\1";|' > tmp/build.less

# vars first
find . -name "*variables.less"\
       -not -path "./node_modules/*"\
       -not -path "./tmp/*" | sed 's|\(.*\)|@import ".\1";|' >> tmp/build.less

# modules (order irrelevant)
find . -name "*.less"\
       -not -path "*reset.less"\
       -not -path "*variables.less"\
       -not -path "*utilities.less"\
       -not -path "./node_modules/*"\
       -not -path "./tmp/*" | sed 's|\(.*\)|@import ".\1";|' >> tmp/build.less

# overrides
find . -name "*utilities.less"\
       -not -path "./node_modules/*"\
       -not -path "./tmp/*" | sed 's|\(.*\)|@import ".\1";|' >> tmp/build.less

# compile
if [ "$NODE_ENV" = "production" ]; then
  lessc -x tmp/build.less | autoprefixer > share/build.css
else
  lessc --source-map-map-inline tmp/build.less | autoprefixer > share/build.css
fi
